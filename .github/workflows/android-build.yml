name: Android Build & Pre-Release

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Decode Keystore
      run: |
        echo "${{ secrets.SIGNING_KEY }}" | base64 -d > ${{ github.workspace }}/keystore.jks
        echo "âœ… Keystore decoded"
      
    - name: Build Release APK
      run: |
        ./gradlew assembleRelease \
          -Pandroid.injected.signing.store.file=${{ github.workspace }}/keystore.jks \
          -Pandroid.injected.signing.store.password=${{ secrets.KEY_STORE_PASSWORD }} \
          -Pandroid.injected.signing.key.alias=${{ secrets.KEY_ALIAS }} \
          -Pandroid.injected.signing.key.password=${{ secrets.KEY_PASSWORD }} \
          --stacktrace
        echo "âœ… Signed Release APK built"

    - name: Build Debug APK
      run: ./gradlew assembleDebug --stacktrace
      
    - name: Optimize and Sign APK
      run: |
        # Find and optimize APKs
        RELEASE_APK=$(find app/build/outputs/apk/release -name "*.apk" -type f | head -1)
        if [ -n "$RELEASE_APK" ]; then
          ANDROID_HOME="${ANDROID_HOME:-/usr/local/lib/android/sdk}"
          BUILD_TOOLS_VERSION=$(ls -1 "$ANDROID_HOME/build-tools" | sort -V | tail -1)
          ZIPALIGN="$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/zipalign"
          APKSIGNER="$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/apksigner"
          
          if [ -f "$ZIPALIGN" ] && [ -f "$APKSIGNER" ]; then
            ALIGNED_APK="${RELEASE_APK%.apk}-aligned.apk"
            
            # Step 1: Zipalign (this invalidates the existing v1/v2/v3 signatures)
            "$ZIPALIGN" -v 4 "$RELEASE_APK" "$ALIGNED_APK"
            mv "$ALIGNED_APK" "$RELEASE_APK"
            echo "âœ… APK optimized with zipalign"
            
            # Step 2: Re-Sign the aligned APK using the decoded keystore
            "$APKSIGNER" sign \
              --ks ${{ github.workspace }}/keystore.jks \
              --ks-key-alias ${{ secrets.KEY_ALIAS }} \
              --ks-pass pass:${{ secrets.KEY_STORE_PASSWORD }} \
              --key-pass pass:${{ secrets.KEY_PASSWORD }} \
              "$RELEASE_APK"
            echo "âœ… APK signed with apksigner (v2/v3 signatures restored)"
          else
            echo "âš ï¸ Could not find zipalign or apksigner in $ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/"
          fi
        fi
        
    - name: Get version name
      id: version
      run: |
        VERSION=$(grep -oP 'versionName\s*=\s*"\K[^"]+' app/build.gradle.kts || echo "1.0.0")
        BUILD_NUMBER=${{ github.run_number }}
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "build=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
        echo "tag=v${VERSION}-build${BUILD_NUMBER}" >> $GITHUB_OUTPUT
        
    - name: Rename and prepare APK files
      run: |
        VERSION=${{ steps.version.outputs.version }}
        BUILD=${{ steps.version.outputs.build }}
        
        # Rename Debug APK
        if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          mv app/build/outputs/apk/debug/app-debug.apk "app/build/outputs/apk/debug/HSRGraphicDroid-v${VERSION}-build${BUILD}-debug.apk"
          echo "âœ… Debug APK renamed"
        fi
        
        # Handle Release APK (signed or unsigned)
        if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
          mv app/build/outputs/apk/release/app-release.apk "app/build/outputs/apk/release/HSRGraphicDroid-v${VERSION}-build${BUILD}-release.apk"
          echo "âœ… Signed Release APK renamed"
        elif [ -f "app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
          mv app/build/outputs/apk/release/app-release-unsigned.apk "app/build/outputs/apk/release/HSRGraphicDroid-v${VERSION}-build${BUILD}-release-unsigned.apk"
          echo "âš ï¸ Unsigned Release APK renamed"
        fi
        
        # Show APK sizes
        echo ""
        echo "ðŸ“¦ APK Sizes:"
        ls -lh app/build/outputs/apk/debug/*.apk 2>/dev/null || true
        ls -lh app/build/outputs/apk/release/*.apk 2>/dev/null || true
        
    - name: Delete old pre-releases
      uses: dev-drprasad/delete-older-releases@v0.3.4
      if: github.event_name == 'push'
      with:
        keep_latest: 5
        delete_tags: true
        delete_prerelease_only: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create Pre-Release
      uses: softprops/action-gh-release@v1
      if: github.event_name == 'push'
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: Pre-Release ${{ steps.version.outputs.version }} (Build ${{ steps.version.outputs.build }})
        body: |
          ## Automated Pre-Release Build
          
          **Version:** ${{ steps.version.outputs.version }}
          **Build Number:** ${{ steps.version.outputs.build }}
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          
          ### Build Artifacts
          - **Release APK**: Signed and optimized production build
          - **Debug APK**: Unobfuscated testing build with detailed logs
          
          ### Optimizations Applied
          - R8/ProGuard minification
          - Resource shrinking
          - APK signature and zipalign optimization
          
          ### Pre-Release Notice
          This is an automated pre-release build generated directly from the latest commit. It may contain bugs or unstable features.
          
          ### Changelog
          ${{ github.event.head_commit.message }}
          
          ---
          *Built automatically by GitHub Actions*
        draft: false
        prerelease: true
        files: |
          app/build/outputs/apk/debug/HSRGraphicDroid-*.apk
          app/build/outputs/apk/release/HSRGraphicDroid-*.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload Debug APK as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: app/build/outputs/apk/debug/*.apk
        retention-days: 30
        
    - name: Upload Release APK as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: release-apk
        path: app/build/outputs/apk/release/*.apk
        retention-days: 90

    - name: Cleanup Keystore
      if: always()
      run: rm -f ${{ github.workspace }}/keystore.jks
        
    - name: Build Summary
      if: always()
      run: |
        echo "## ðŸ“Š Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Version | ${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build | ${{ steps.version.outputs.build }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Tag | ${{ steps.version.outputs.tag }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ APK Sizes" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        ls -lh app/build/outputs/apk/debug/*.apk 2>/dev/null >> $GITHUB_STEP_SUMMARY || true
        ls -lh app/build/outputs/apk/release/*.apk 2>/dev/null >> $GITHUB_STEP_SUMMARY || true
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
